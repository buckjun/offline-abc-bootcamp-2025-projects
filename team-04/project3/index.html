<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 여행 일정 추천기</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f5f7fa; padding: 2rem; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; }
    .input-group { margin-bottom: 1rem; }
    label { font-weight: bold; display: block; margin-bottom: 0.4rem; }
    input, select, button { padding: 0.6rem; font-size: 1rem; width: 100%; box-sizing: border-box; }
    button { background-color: #2c3e50; color: white; border: none; cursor: pointer; }
    #result, #budgetSection { background-color: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 1.5rem; }
    #tableWrapper { background: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background-color: #eee; }
  </style>
</head>
<body>
  <h1>🌏 AI 여행 일정 추천기</h1>

  <div class="input-group">
    <label for="budget">예산 (KRW):</label>
    <input type="number" id="budget" placeholder="예: 2000000" />
  </div>

  <div class="input-group">
    <label for="people">인원 수:</label>
    <input type="number" id="people" placeholder="예: 2명" min="1" />
  </div>

  <div class="input-group">
    <label for="days">여행 기간 (일):</label>
    <input type="number" id="days" placeholder="예: 3일" min="1" />
  </div>

  <div class="input-group">
    <label for="themeEmotion">테마 감정:</label>
    <input type="text" id="themeEmotion" placeholder="예: 설렘, 힐링, 모험" />
  </div>

  <div class="input-group">
    <label for="departure">출발지:</label>
    <input type="text" id="departure" placeholder="예: 서울, 대전" />
  </div>

  <div class="input-group">
    <label for="theme">여행 테마:</label>
    <select id="theme">
      <option value="힐링">힐링</option>
      <option value="액티비티">액티비티</option>
      <option value="미식">미식</option>
      <option value="자연">자연</option>
    </select>
  </div>

  <div class="input-group">
    <label for="region">여행지 추천 방식:</label>
    <select id="region">
      <option value="랜덤">랜덤 추천</option>
      <option value="조건">AI 조건 기반</option>
    </select>
  </div>

  <div class="input-group">
    <label for="travelType">여행 타입:</label>
    <select id="travelType">
      <option value="국내">국내</option>
      <option value="해외">해외</option>
    </select>
  </div>

  <button onclick="getItinerary()">여행 일정 생성하기</button>

  <div id="result">일정 정보가 여기에 표시됩니다...</div>
  <div id="tableWrapper"></div>
  <div id="budgetSection">
    <canvas id="budgetChart" width="400" height="400"></canvas>
  </div>

  <script>
    let budgetChartInstance = null;

    async function getItinerary() {
      const budget = parseInt(document.getElementById('budget').value);
      const people = parseInt(document.getElementById('people').value);
      const days = parseInt(document.getElementById('days').value);
      const themeEmotion = document.getElementById('themeEmotion').value.trim();
      const departure = document.getElementById('departure').value.trim();
      const theme = document.getElementById('theme').value;
      const regionPref = document.getElementById('region').value;
      const travelType = document.getElementById('travelType').value;
      const resultDiv = document.getElementById('result');
      const tableWrapper = document.getElementById('tableWrapper');
      const ctx = document.getElementById('budgetChart').getContext('2d');

      // 입력 검증
      if (!budget || budget <= 0 || !people || people <= 0 || !days || days <= 0 || !departure) {
        alert('예산, 인원 수, 여행 기간, 출발지를 모두 올바르게 입력해주세요.');
        return;
      }

      // UI 초기화
      resultDiv.innerHTML = '로딩 중...';
      tableWrapper.innerHTML = '';
      if (budgetChartInstance) {
        budgetChartInstance.destroy();
        budgetChartInstance = null;
      }

      // 프롬프트 구성
      const isOverseas = travelType === '해외';
      let prompt = `너는 ${isOverseas ? '해외' : '국내'} 여행 일정을 현실적으로 짜주는 AI야. 사용자 입력 정보는 다음과 같아:\n` +
                   `- 예산: ${budget}원\n` +
                   `- 인원 수: ${people}명\n` +
                   `- 여행 기간: ${days}일\n` +
                   `- 테마 감정: ${themeEmotion}\n` +
                   `- 출발지: ${departure}\n` +
                   `- 여행 테마: ${theme}\n` +
                   `- 여행지 추천 방식: ${regionPref === '랜덤' ? '무작위 추천' : 'AI 조건 기반'}\n`;
      if (isOverseas) {
        prompt += `
해외여행이므로 항공권 정보(출발/도착 시간, 예상 요금)을 포함해 자세히 알려줘. 시차를 고려해 일정을 조정하고, 여행지 설명도 풍부하게 작성해줘. 인원 수, 테마 감정, 여행 기간을 반영해 활동을 추천해줘.\n`;
      } else {
        prompt += `
국내여행이므로 교통수단과 소요 시간을 포함해 일정표를 짜줘. 인원 수, 테마 감정, 여행 기간을 반영해 일정과 숙소 추천을 최적화해줘.\n`;
      }
      prompt += `
응답은 아래 형식으로 제공해줘:\n` +
                `1. 추천 여행지 정보(도시 이름 + 상세 설명)\n` +
                `2. 각 날짜별 상세 일정(시간 | 활동)을 HTML 표(table) 형식으로 제공, “🗓️ Day 1” 등 날짜 제목 포함 (총 ${days}일 일정)\n` +
                `3. 마지막에 예산 분배를 JSON 형태로 제공하되, 사용자에게는 보이지 않게 숨겨서 제공해줘:\n` +
                `<!--BUDGET_JSON_START-->\n` +
                `{\n` +
                `  "항공": 숫자,\n` +
                `  "숙박": 숫자,\n` +
                `  "식사": 숫자,\n` +
                `  "활동": 숫자,\n` +
                `  "기타": 숫자\n` +
                `}\n` +
                `<!--BUDGET_JSON_END-->`;

      // 스트리밍 요청
      const response = await fetch('http://localhost:5000/generate/stream', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: [
          { role: 'system', content: '너는 현실적인 여행 일정을 계획해주는 전문가야.' },
          { role: 'user', content: prompt }
        ] })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullText = '';
      resultDiv.innerHTML = '';

      // 스트림 렌더링
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        fullText += decoder.decode(value);
        const displayText = fullText.replace(/<!--BUDGET_JSON_START-->[\s\S]*?<!--BUDGET_JSON_END-->/, '');
        resultDiv.innerHTML = displayText;
      }

      // 숨겨진 JSON 추출
      const jsonMatch = fullText.match(/<!--BUDGET_JSON_START-->[\s\S]*?<!--BUDGET_JSON_END-->/);
      let budgetObj = null;
      if (jsonMatch) {
        try { budgetObj = JSON.parse(jsonMatch[1]); } catch (e) { console.error('예산 JSON 파싱 오류', e); }
      }

      // 일정표 분리
      const container = document.createElement('div');
      container.innerHTML = resultDiv.innerHTML;
      const table = container.querySelector('table');
      if (table) {
        tableWrapper.innerHTML = table.outerHTML;
        table.remove();
      }
      resultDiv.innerHTML = container.innerHTML.trim() || '일정 정보가 없습니다.';

      // 차트 렌더링
      if (budgetObj) {
        budgetChartInstance = new Chart(ctx, {
          type: 'pie', data: { labels: Object.keys(budgetObj), datasets: [{ data: Object.values(budgetObj) }] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: '예산 분배' } } }
        });
      }
    }
  </script>
</body>
</html>
